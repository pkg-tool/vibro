#!/usr/bin/env bash

set -euo pipefail
source script/lib/blob-store.sh

build_flag="--release"
profile_dir="release"
open_result=false
local_install=false
can_code_sign=false
target_root_dir="${CARGO_TARGET_DIR:-target}"

# This must match the team in the provisioning profile.
IDENTITY="Vector"
APPLE_NOTARIZATION_TEAM="MQ55VZLNZQ"

# Function for displaying help info
help_info() {
  echo "
Usage: ${0##*/} [options] [architecture=host]
Build the application bundle for macOS.

Options:
  -d    Compile in debug mode
  -o    Open dir with the resulting DMG or launch the app itself in local mode.
  -i    Install the resulting DMG into /Applications.
  -h    Display this help and exit.
  "
}

while getopts 'doih' flag
do
    case "${flag}" in
        o) open_result=true;;
        d)
            export CARGO_INCREMENTAL=true
            export CARGO_BUNDLE_SKIP_BUILD=true
            build_flag="";
            profile_dir="debug"
            ;;
        i) local_install=true;;
        h)
           help_info
           exit 0
           ;;
    esac
done

shift $((OPTIND-1))


channel=$(<crates/release_channel/RELEASE_CHANNEL)
if [[ "${channel}" != "stable" ]]; then
    echo "This fork builds stable bundles only; got crates/release_channel/RELEASE_CHANNEL='${channel}'."
    echo "Set it to 'stable' and re-run."
    exit 1
fi

export VECTOR_BUNDLE=true

if ! cargo bundle --version >/dev/null 2>&1; then
    cargo install cargo-bundle --version 0.9.0 --locked
fi

# Deal with versions of macOS that don't include libstdc++ headers
export CXXFLAGS="-stdlib=libc++"

version="$(script/get-crate-version vector)"
export RELEASE_VERSION="${version}"
export VECTOR_RELEASE_CHANNEL="${channel}"

version_info=$(rustc --version --verbose)
host_line=$(echo "$version_info" | grep host)
target_triple=${host_line#*: }
if [[ $# -gt 0 && -n "$1" ]]; then
    target_triple="$1"
fi
arch_suffix=""

if [[ "$target_triple" = "x86_64-apple-darwin" ]]; then
    arch_suffix="x86_64"
elif [[ "$target_triple" = "aarch64-apple-darwin" ]]; then
    arch_suffix="aarch64"
else
    echo "Unsupported architecture $target_triple"
    exit 1
fi

# Generate the licenses first, so they can be baked into the binaries
script/generate-licenses

rustup target add $target_triple

echo "Compiling Vector binaries"
cargo build ${build_flag} --package vector --package cli --target $target_triple

echo "Creating application bundle"
app_path=$(cargo bundle ${build_flag} --package vector --target $target_triple | xargs)
echo "Bundled ${app_path}"

# DocumentTypes.plist references CFBundleTypeIconFile "Document", so the bundle must contain Document.icns.
# We use the app icon as a placeholder document icon for now.
document_icon_source="crates/vector/resources/Document.icns"
document_icon_target="${app_path}/Contents/Resources/Document.icns"
if [[ -f "${document_icon_source}" ]]; then
    mkdir -p "$(dirname "${document_icon_target}")"
    cp "${document_icon_source}" "${document_icon_target}"
else
    echo "cargo::warning=Missing ${document_icon_source}; macOS document icons may not appear in Finder."
fi

if [[ -n "${MACOS_CERTIFICATE:-}" && -n "${MACOS_CERTIFICATE_PASSWORD:-}" && -n "${APPLE_NOTARIZATION_KEY:-}" && -n "${APPLE_NOTARIZATION_KEY_ID:-}" && -n "${APPLE_NOTARIZATION_ISSUER_ID:-}" ]]; then
    can_code_sign=true

    echo "Setting up keychain for code signing..."
    security create-keychain -p "$MACOS_CERTIFICATE_PASSWORD" vector.keychain || echo ""
    security default-keychain -s vector.keychain
    security unlock-keychain -p "$MACOS_CERTIFICATE_PASSWORD" vector.keychain
    # Calling set-keychain-settings without `-t` disables the auto-lock timeout
    security set-keychain-settings vector.keychain
    echo "$MACOS_CERTIFICATE" | base64 --decode > /tmp/vector-certificate.p12
    security import /tmp/vector-certificate.p12 -k vector.keychain -P "$MACOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
    rm /tmp/vector-certificate.p12
    security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$MACOS_CERTIFICATE_PASSWORD" vector.keychain

    function cleanup() {
        echo "Cleaning up keychain"
        security default-keychain -s login.keychain
        security delete-keychain vector.keychain
    }

    trap cleanup EXIT
fi

function sign_app_binaries() {
    mkdir -p "${app_path}/Contents/Frameworks"

    # Note: The app identifier for our development builds is the same as the app identifier for nightly.
    cp crates/vector/contents/$channel/embedded.provisionprofile "${app_path}/Contents/"

    if [[ $can_code_sign = true ]]; then
        echo "Code signing binaries"
        # sequence of codesign commands modeled after this example: https://developer.apple.com/forums/thread/701514
        /usr/bin/codesign --deep --force --timestamp --options runtime --sign "$IDENTITY" "${app_path}/Contents/MacOS/cli" -v
        /usr/bin/codesign --deep --force --timestamp --options runtime --entitlements crates/vector/resources/vector.entitlements --sign "$IDENTITY" "${app_path}/Contents/MacOS/vector" -v
        /usr/bin/codesign --force --timestamp --options runtime --entitlements crates/vector/resources/vector.entitlements --sign "$IDENTITY" "${app_path}" -v
    else
        echo "One or more of the following variables are missing: MACOS_CERTIFICATE, MACOS_CERTIFICATE_PASSWORD, APPLE_NOTARIZATION_KEY, APPLE_NOTARIZATION_KEY_ID, APPLE_NOTARIZATION_ISSUER_ID"

        echo "====== WARNING ======"
        echo "This bundle is being signed without all entitlements, some features (e.g. universal links) will not work"
        echo "====== WARNING ======"

        # NOTE: if you need to test universal links you have a few paths forward:
        # - create a PR and tag it with the `run-bundling` label, and download the .dmg file from there.
        # - get a signing key for the MQ55VZLNZQ team from Nathan.
        # - create your own signing key, and update references to MQ55VZLNZQ to your own team ID
        # then comment out this line.
        cat crates/vector/resources/vector.entitlements | sed '/com.apple.developer.associated-domains/,+1d' > "${app_path}/Contents/Resources/vector.entitlements"

        codesign --force --deep --entitlements "${app_path}/Contents/Resources/vector.entitlements" --sign ${MACOS_SIGNING_KEY:- -} "${app_path}" -v
    fi

    bundle_name=$(basename "$app_path")

    if [ "$local_install" = true ]; then
        rm -rf "/Applications/$bundle_name"
        mv "$app_path" "/Applications/$bundle_name"
        echo "Installed application bundle: /Applications/$bundle_name"
        if [ "$open_result" = true ]; then
            echo "Opening /Applications/$bundle_name"
            open "/Applications/$bundle_name"
        fi
        return 0
    elif [ "$open_result" = true ]; then
        if [[ "$profile_dir" = "debug" ]]; then
            open "$app_path"
        fi
    fi

    if [[ "$profile_dir" = "debug" ]]; then
        echo "Debug build detected - skipping DMG creation and signing"
        if [ "$local_install" = false ]; then
            echo "Created application bundle:"
            echo "$app_path"
        fi
    else
        dmg_target_directory="${target_root_dir}/${target_triple}/${profile_dir}"
        dmg_source_directory="${dmg_target_directory}/dmg"
        dmg_file_path="${dmg_target_directory}/Vector.dmg"
        xcode_bin_dir_path="$(xcode-select -p)/usr/bin"

        rm -rf ${dmg_source_directory}
        mkdir -p ${dmg_source_directory}
        mv "${app_path}" "${dmg_source_directory}"
        notarization_key_file=$(mktemp)

        echo "Adding symlink to /Applications to ${dmg_source_directory}"
        ln -s /Applications ${dmg_source_directory}

        echo "Creating final DMG at ${dmg_file_path} using ${dmg_source_directory}"
        hdiutil create -volname Vector -srcfolder "${dmg_source_directory}" -ov -format UDZO "${dmg_file_path}"

        # If someone runs this bundle script locally, a symlink will be placed in `dmg_source_directory`.
        # This symlink causes CPU issues if the codebase is the project being worked on, so we simply remove it for now.
        echo "Removing symlink to /Applications from ${dmg_source_directory}"
        rm ${dmg_source_directory}/Applications

        if [[ -f script/terms/terms.json ]]; then
            if command -v dmg-license >/dev/null 2>&1; then
                echo "Adding license agreement to DMG"
                dmg-license script/terms/terms.json "${dmg_file_path}"
            else
                echo "Skipping DMG license agreement (dmg-license not found)."
                echo "Install with: npm install --global dmg-license minimist"
            fi
        else
            echo "Skipping DMG license agreement (script/terms/terms.json not found)"
        fi

        if [[ $can_code_sign = true ]]; then
            echo "Notarizing DMG with Apple"
            /usr/bin/codesign --deep --force --timestamp --options runtime --sign "$IDENTITY" "$(pwd)/${dmg_file_path}" -v
            echo "$APPLE_NOTARIZATION_KEY" > "$notarization_key_file"
            "${xcode_bin_dir_path}/notarytool" submit --wait --key "$notarization_key_file" --key-id "$APPLE_NOTARIZATION_KEY_ID" --issuer "$APPLE_NOTARIZATION_ISSUER_ID" "${dmg_file_path}"
            rm "$notarization_key_file"
            "${xcode_bin_dir_path}/stapler" staple "${dmg_file_path}"
        fi

        if [ "$open_result" = true ]; then
            open "$dmg_target_directory"
        fi
    fi
}

function sign_binary() {
    local binary_path=$1

    if [[ $can_code_sign = true ]]; then
        echo "Code signing executable $binary_path"
        /usr/bin/codesign --deep --force --timestamp --options runtime --entitlements crates/vector/resources/vector.entitlements --sign "$IDENTITY" "${binary_path}" -v
    fi
}

function upload_debug_symbols() {
    if [ "$local_install" = true ]; then
        echo "local install; skipping sentry upload."
    elif [[ -n "${SENTRY_AUTH_TOKEN:-}" ]]; then
        echo "Uploading vector debug symbols to sentry..."
        if ! dsymutil --flat "${target_root_dir}/${target_triple}/${profile_dir}/vector" 2> "${target_root_dir}/dsymutil.log"; then
            echo "dsymutil failed"
            cat "${target_root_dir}/dsymutil.log"
            exit 1
        fi
        if ! dsymutil --flat "${target_root_dir}/${target_triple}/${profile_dir}/cli" 2> "${target_root_dir}/dsymutil.log"; then
            echo "dsymutil failed"
            cat "${target_root_dir}/dsymutil.log"
            exit 1
        fi
        for attempt in 1 2 3; do
            echo "Sentry upload attempt $attempt..."
            if sentry-cli debug-files upload --include-sources --wait -p vector -o vector \
                "${target_root_dir}/${target_triple}/${profile_dir}/vector.dwarf" \
                "${target_root_dir}/${target_triple}/${profile_dir}/cli.dwarf"; then
                break
            else
                echo "Sentry upload failed on attempt $attempt"
                if [ $attempt -eq 3 ]; then
                    echo "All sentry upload attempts failed"
                    exit 1
                fi
            fi
        done
    else
        echo "missing SENTRY_AUTH_TOKEN. skipping sentry upload."
    fi
}

upload_debug_symbols

cp "${target_root_dir}/${target_triple}/${profile_dir}/cli" "${app_path}/Contents/MacOS/cli"
sign_app_binaries
